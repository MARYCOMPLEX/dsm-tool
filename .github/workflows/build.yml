name: Build GPU-Enabled DSM Tool

on:
  workflow_dispatch:

env:
  NUITKA_CACHE_DIR: ${{ github.workspace }}\.nuitka_cache
  CLCACHE_DIR: ${{ github.workspace }}\.clcache
  PYTHONUTF8: "1"
  PYTHONIOENCODING: "utf-8"

jobs:
  # --- 1. Torch 预编译 ---
  pre-torch:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-torch
          restore-keys: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-
      - name: Install & Compile
        run: |
          pip install nuitka
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124
          # 不再使用 --stop-after，直接打一个 standalone 包来产生缓存
          python -m nuitka --standalone --include-package=torch --jobs=2 --output-dir=temp_build pre_compile.py torch
      - name: Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-torch

  # --- 2. UI 预编译 ---
  pre-ui:
    needs: pre-torch
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-ui
          restore-keys: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-torch
      - name: Install & Compile
        run: |
          pip install nuitka PyQt6
          python -m nuitka --standalone --include-package=PyQt6 --jobs=2 --output-dir=temp_build pre_compile.py qt
      - name: Save
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-ui

  # --- 3. Scientific 预编译 ---
  pre-sci:
    needs: pre-ui
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-sci
          restore-keys: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-ui
      - name: Install & Compile
        run: |
          pip install nuitka numpy rasterio scipy
          python -m nuitka --standalone --include-package=numpy --include-package=rasterio --jobs=2 --output-dir=temp_build pre_compile.py sci
      - name: Save
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-sci

  # --- 4. GDAL 预编译 ---
  pre-gdal:
    needs: pre-sci
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-gdal
          restore-keys: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-sci
      - name: Install & Compile
        run: |
          pip install nuitka
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl
          python -m nuitka --standalone --include-package=osgeo --jobs=2 --output-dir=temp_build pre_compile.py osgeo
      - name: Save
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-gdal

  # --- 5. 最终打包 ---
  final-build:
    needs: pre-gdal
    runs-on: windows-latest
    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore Full Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-final-${{ github.run_id }}
          restore-keys: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-gdal
      - name: Install All requirements
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -r requirements-ci.txt
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl
      - name: Run Nuitka Build
        shell: pwsh
        run: python nuitka_build.py
        env:
          GITHUB_ACTIONS: true
      - name: Save Final Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt') }}-final-${{ github.run_id }}
      - name: Zip & Upload
        shell: pwsh
        run: Compress-Archive -Path "build/DSM_Tool.dist/*" -DestinationPath "DSM_Tool_GPU_v1.0.zip"
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_GPU_Binary
          path: DSM_Tool_GPU_v1.0.zip
          retention-days: 5