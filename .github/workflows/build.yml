name: Build GPU-Enabled DSM Tool (Lite -> Heavy -> Final)

on:
  workflow_dispatch:

env:
  NUITKA_CACHE_DIR: ${{ github.workspace }}\.nuitka_cache
  CLCACHE_DIR: ${{ github.workspace }}\.clcache
  PYTHONUTF8: "1"
  PYTHONIOENCODING: "utf-8"
  CL: "/Zm500"
  # 你的最终产物名（会生成 build/DSM_Tool.dist）
  APP_NAME: "DSM_Tool"
  # 你的入口脚本：如果不是 main.py，请改这里（或在仓库里创建同名入口文件）
  ENTRY_SCRIPT: "main.py"
  # Nuitka 并发
  NUITKA_JOBS: "2"

jobs:
  # -------------------------
  # 1) 轻量：UI（PyQt6）
  # -------------------------
  pre-ui:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore Cache (ui)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-ui
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Install (ui)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka clcache PyQt6

      - name: Pre-compile (ui)
        shell: pwsh
        env:
          PRE_TARGET: qt
        run: |
          python -m nuitka `
            --standalone --jobs=${{ env.NUITKA_JOBS }} --output-dir=temp_build `
            --assume-yes-for-downloads `
            --enable-plugin=pyqt6 `
            pre_build.py

      - name: Save Cache (ui)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-ui

  # -------------------------
  # 2) 轻量：科学栈（numpy/scipy/skimage/rasterio）
  # -------------------------
  pre-sci:
    needs: pre-ui
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore Cache (sci)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-sci
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Install (sci)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka clcache
          pip install numpy rasterio scipy scikit-image

      - name: Pre-compile (sci)
        shell: pwsh
        env:
          PRE_TARGET: sci
        run: |
          python -m nuitka `
            --standalone --jobs=${{ env.NUITKA_JOBS }} --output-dir=temp_build `
            --assume-yes-for-downloads `
            pre_build.py

      - name: Save Cache (sci)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-sci

  # -------------------------
  # 3) 轻量：GDAL（osgeo）
  # -------------------------
  pre-gdal:
    needs: pre-sci
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore Cache (gdal)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-gdal
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Install (gdal)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka clcache
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl

      - name: Pre-compile (gdal)
        shell: pwsh
        env:
          PRE_TARGET: osgeo
        run: |
          python -m nuitka `
            --standalone --jobs=${{ env.NUITKA_JOBS }} --output-dir=temp_build `
            --assume-yes-for-downloads `
            pre_build.py

      - name: Save Cache (gdal)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-gdal

  # -------------------------
  # 4) 轻量：misc（matplotlib/cv2/tifffile/einops）
  # -------------------------
  pre-misc:
    needs: pre-gdal
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore Cache (misc)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-misc
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Install (misc)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka clcache
          pip install matplotlib einops tifffile opencv-python pillow

      - name: Pre-compile (misc)
        shell: pwsh
        env:
          PRE_TARGET: misc
        run: |
          python -m nuitka `
            --standalone --jobs=${{ env.NUITKA_JOBS }} --output-dir=temp_build `
            --assume-yes-for-downloads `
            --enable-plugin=pyqt6 `
            pre_build.py

      - name: Save Cache (misc)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-misc

  # -------------------------
  # 5) 重型：torch（放到最后预编译，避免一开始就炸）
  #    重点：不要 --include-package=torch
  # -------------------------
  pre-torch:
    needs: pre-misc
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore Cache (torch)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-torch
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Install (torch)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka clcache
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124

      - name: Pre-compile (torch)
        shell: pwsh
        env:
          PRE_TARGET: torch
        run: |
          python -m nuitka `
            --standalone --jobs=${{ env.NUITKA_JOBS }} --output-dir=temp_build `
            --assume-yes-for-downloads `
            pre_build.py

      - name: Save Cache (torch)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-torch

  # -------------------------
  # 6) 最终打包（一定带 --assume-yes-for-downloads，避免再次卡 depends）
  # -------------------------
  final-build:
    needs: pre-torch
    runs-on: windows-latest
    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Restore Cache (final)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-final
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Install All requirements
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka clcache
          pip install -r requirements-ci.txt
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl

      - name: Run Nuitka Build
        shell: pwsh
        env:
          GITHUB_ACTIONS: true
          BUILD_PROFILE: full
        run: |
          python nuitka_build.py

      - name: Save Cache (final)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-${{ github.sha }}-a${{ github.run_attempt }}-final

      - name: Zip & Upload
        shell: pwsh
        run: |
          Compress-Archive -Path "build/${{ env.APP_NAME }}.dist/*" -DestinationPath "${{ env.APP_NAME }}_GPU.zip"

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_GPU_Binary
          path: ${{ env.APP_NAME }}_GPU.zip
          retention-days: 5