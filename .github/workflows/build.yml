name: Build GPU-Enabled DSM Tool

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      NUITKA_CACHE_DIR: ${{ github.workspace }}\.nuitka_cache
      CLCACHE_DIR: ${{ github.workspace }}\.clcache
      PYTHONUTF8: "1"
      PYTHONIOENCODING: "utf-8"

    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-ci.txt

      - name: Restore Nuitka and clcache
        id: cache_restore
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-${{ runner.os }}-py312-${{ hashFiles('requirements-ci.txt') }}-${{ github.run_id }}
          restore-keys: |
            nuitka-${{ runner.os }}-py312-${{ hashFiles('requirements-ci.txt') }}-
            nuitka-${{ runner.os }}-py312-

      - name: Install requirements
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -r requirements-ci.txt

      - name: Install CUDA Torch and GDAL
        shell: pwsh
        run: |
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl

      - name: Run Nuitka Build
        shell: pwsh
        run: python nuitka_build.py
        env:
          GITHUB_ACTIONS: true

      - name: Save Nuitka and clcache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-${{ runner.os }}-py312-${{ hashFiles('requirements-ci.txt') }}-${{ github.run_id }}

      - name: Zip Result
        shell: pwsh
        run: |
          Compress-Archive -Path "build/DSM_Tool.dist/*" -DestinationPath "DSM_Tool_GPU_v1.0.zip"

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_GPU_Binary
          path: DSM_Tool_GPU_v1.0.zip
          retention-days: 5
