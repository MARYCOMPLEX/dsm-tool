name: Multi-Stage Turbo Cache Build

on:
  workflow_dispatch:

# 通用缓存配置模板
env:
  CACHE_PATH: |
    ~/.cache/nuitka
    ~/AppData/Local/Nuitka/Nuitka/Cache
  CACHE_KEY_PREFIX: nuitka-v1-py312

jobs:
  # --- 阶段 1: 编译 Torch (耗时最长，独立出来) ---
  pre-torch:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install
        run: pip install nuitka torch torchvision --index-url https://download.pytorch.org/whl/cu124
      - name: Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-torch
      - name: Compile Torch
        run: python -m nuitka --standalone --compile-only --include-package=torch --jobs=2 pre_compile.py torch

  # --- 阶段 2: 编译 科学计算包 (并行执行) ---
  pre-sci:
    needs: pre-torch # 继承 Torch 的缓存基础
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install
        run: pip install nuitka numpy rasterio scipy scikit-image
      - name: Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-sci
          restore-keys: ${{ env.CACHE_KEY_PREFIX }}-torch
      - name: Compile Sci
        run: python -m nuitka --standalone --compile-only --include-package=numpy --include-package=rasterio --jobs=2 pre_compile.py sci

  # --- 阶段 3: 编译 UI 和 GDAL (并行执行) ---
  pre-ui-gdal:
    needs: pre-torch
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install
        run: pip install nuitka PyQt6 ./libs/GDAL-3.11.4-cp312-cp312-win_amd64.whl
      - name: Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-ui-gdal
          restore-keys: ${{ env.CACHE_KEY_PREFIX }}-torch
      - name: Compile UI/GDAL
        run: python -m nuitka --standalone --compile-only --include-package=PyQt6 --include-package=osgeo --jobs=2 pre_compile.py qt

  # --- 阶段 4: 终极汇总打包 ---
  final-build:
    needs: [pre-sci, pre-ui-gdal]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install All
        run: |
          pip install nuitka torch torchvision --index-url https://download.pytorch.org/whl/cu124
          pip install PyQt6 numpy rasterio scipy scikit-image matplotlib einops tifffile opencv-python
          pip install ./libs/GDAL-3.11.4-cp312-cp312-win_amd64.whl
      - name: Restore Global Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ env.CACHE_KEY_PREFIX }}-final-${{ github.sha }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-sci
            ${{ env.CACHE_KEY_PREFIX }}-ui-gdal
            ${{ env.CACHE_KEY_PREFIX }}-torch
      - name: Final Build
        run: python nuitka_build.py
        env:
          GITHUB_ACTIONS: true