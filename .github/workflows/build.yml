name: Build DSM Tool (Lite first)

on:
  workflow_dispatch:
    inputs:
      run_heavy:
        type: boolean
        required: false
        default: false

env:
  NUITKA_CACHE_DIR: ${{ github.workspace }}\.nuitka_cache
  CLCACHE_DIR: ${{ github.workspace }}\.clcache
  PYTHONUTF8: "1"
  PYTHONIOENCODING: "utf-8"
  CL: "/Zm500"

jobs:
  pre-lite:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-lite
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-
            nuitka-Win-py312-
      - name: Install deps (lite)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka
          pip install PyQt6
          pip install numpy rasterio scipy scikit-image matplotlib einops tifffile opencv-python
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl
      - name: Pre-compile lite packages
        shell: pwsh
        run: |
          $env:PRE_TARGET="qt"
          python -m nuitka --standalone --jobs=2 --output-dir=temp_build pre_build.py
          $env:PRE_TARGET="sci"
          python -m nuitka --standalone --jobs=2 --output-dir=temp_build pre_build.py
          $env:PRE_TARGET="osgeo"
          python -m nuitka --standalone --jobs=2 --output-dir=temp_build pre_build.py
          $env:PRE_TARGET="misc"
          python -m nuitka --standalone --jobs=2 --output-dir=temp_build pre_build.py
      - name: Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-lite-${{ github.run_id }}

  final-lite:
    needs: pre-lite
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-lite
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-
            nuitka-Win-py312-
      - name: Install All requirements (lite)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka
          pip install -r requirements-ci.txt
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl
      - name: Run Nuitka Build (lite)
        shell: pwsh
        env:
          GITHUB_ACTIONS: true
          BUILD_PROFILE: lite
        run: python nuitka_build.py
      - name: Zip & Upload (lite)
        shell: pwsh
        run: |
          Compress-Archive -Path "build/DSM_Tool.dist/*" -DestinationPath "DSM_Tool_LITE.zip"
      - name: Upload Artifact (lite)
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_LITE
          path: DSM_Tool_LITE.zip
          retention-days: 5

  pre-heavy-torch:
    needs: final-lite
    if: ${{ inputs.run_heavy }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-heavy
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-lite
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-
            nuitka-Win-py312-
      - name: Install torch (heavy)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
      - name: Pre-compile torch (no include-package)
        shell: pwsh
        run: |
          $env:PRE_TARGET="torch"
          python -m nuitka --standalone --jobs=2 --output-dir=temp_build pre_build.py
      - name: Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-heavy-${{ github.run_id }}

  final-full:
    needs: pre-heavy-torch
    if: ${{ inputs.run_heavy }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Restore Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
          key: nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-heavy
          restore-keys: |
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-lite
            nuitka-Win-py312-${{ hashFiles('requirements-ci.txt', 'pre_build.py') }}-
            nuitka-Win-py312-
      - name: Install All requirements (full)
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install -U nuitka
          pip install -r requirements-ci.txt
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124
          pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl
      - name: Run Nuitka Build (full)
        shell: pwsh
        env:
          GITHUB_ACTIONS: true
          BUILD_PROFILE: full
        run: python nuitka_build.py
      - name: Zip & Upload (full)
        shell: pwsh
        run: |
          Compress-Archive -Path "build/DSM_Tool.dist/*" -DestinationPath "DSM_Tool_FULL.zip"
      - name: Upload Artifact (full)
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_FULL
          path: DSM_Tool_FULL.zip
          retention-days: 5