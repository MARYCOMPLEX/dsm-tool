name: Build DSM Tool (Ultra Cache: Lite first)

on:
  workflow_dispatch:
    inputs:
      run_heavy:
        type: boolean
        required: false
        default: false

env:
  NUITKA_CACHE_DIR: ${{ github.workspace }}\.nuitka_cache
  CLCACHE_DIR: ${{ github.workspace }}\.clcache
  PIP_CACHE_DIR: ${{ github.workspace }}\.pip_cache

  PYTHONUTF8: "1"
  PYTHONIOENCODING: "utf-8"

  CL: "/Zm2000"
  NUITKA_CLCACHE: "1"
  CLCACHE_HARDLINK: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  pre-lite:
    runs-on: windows-latest
    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12.10"

      - name: Restore pip cache
        uses: actions/cache/restore@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}
          restore-keys: |
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-
            pip-Win-py312-

      - name: Restore venv (lite)
        uses: actions/cache/restore@v4
        with:
          path: .venv_lite
          key: venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            venv-lite-Win-py312-

      - name: Restore build caches (lite)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            build-lite-Win-py312-

      - name: Setup venv (lite) + install deps (ultra cached)
        shell: pwsh
        run: |
          $venv = ".venv_lite"
          if (!(Test-Path "$venv\Scripts\python.exe")) { python -m venv $venv }

          $depsId = "$( (Get-FileHash requirements-ci.txt).Hash )-$( (Get-FileHash pre_build.py).Hash )-$( (Get-FileHash nuitka_build.py).Hash )-lite-gdal3114"
          $stamp = "$venv\.deps_stamp"

          $needInstall = $true
          if (Test-Path $stamp) {
            $old = (Get-Content $stamp -ErrorAction SilentlyContinue)
            if ($old -eq $depsId) { $needInstall = $false }
          }

          if ($needInstall) {
            & "$venv\Scripts\python.exe" -m pip install -U pip --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -U nuitka clcache --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -r requirements-ci.txt --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install PyQt6 numpy rasterio scipy scikit-image matplotlib einops tifffile opencv-python --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl --cache-dir "$env:PIP_CACHE_DIR"
            Set-Content -Path $stamp -Value $depsId -Encoding ascii
          } else {
            Write-Host "Deps stamp matched, skip pip install."
          }

      - name: Pre-compile lite packages (Nuitka, non-interactive)
        shell: pwsh
        run: |
          $py = ".venv_lite\Scripts\python.exe"
          $env:PRE_TARGET="qt"
          & $py -m nuitka --standalone --jobs=2 --output-dir=temp_build --assume-yes-for-downloads --enable-plugin=pyqt6 pre_build.py
          $env:PRE_TARGET="sci"
          & $py -m nuitka --standalone --jobs=2 --output-dir=temp_build --assume-yes-for-downloads pre_build.py
          $env:PRE_TARGET="osgeo"
          & $py -m nuitka --standalone --jobs=2 --output-dir=temp_build --assume-yes-for-downloads pre_build.py
          $env:PRE_TARGET="misc"
          & $py -m nuitka --standalone --jobs=2 --output-dir=temp_build --assume-yes-for-downloads pre_build.py

      - name: Save pip cache (pre-lite)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save venv (lite) (pre-lite)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .venv_lite
          key: venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save build caches (lite) (pre-lite)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

  final-lite:
    needs: pre-lite
    runs-on: windows-latest
    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12.10"

      - name: Restore pip cache
        uses: actions/cache/restore@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}
          restore-keys: |
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-
            pip-Win-py312-

      - name: Restore venv (lite)
        uses: actions/cache/restore@v4
        with:
          path: .venv_lite
          key: venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            venv-lite-Win-py312-

      - name: Restore build caches (lite)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            build-lite-Win-py312-

      - name: Ensure venv ready (lite) (skip if cached)
        shell: pwsh
        run: |
          $venv = ".venv_lite"
          if (!(Test-Path "$venv\Scripts\python.exe")) { python -m venv $venv }

          $depsId = "$( (Get-FileHash requirements-ci.txt).Hash )-$( (Get-FileHash pre_build.py).Hash )-$( (Get-FileHash nuitka_build.py).Hash )-lite-gdal3114"
          $stamp = "$venv\.deps_stamp"

          if (!(Test-Path $stamp) -or ((Get-Content $stamp) -ne $depsId)) {
            & "$venv\Scripts\python.exe" -m pip install -U pip --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -U nuitka clcache --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -r requirements-ci.txt --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install PyQt6 numpy rasterio scipy scikit-image matplotlib einops tifffile opencv-python --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl --cache-dir "$env:PIP_CACHE_DIR"
            Set-Content -Path $stamp -Value $depsId -Encoding ascii
          } else {
            Write-Host "Deps stamp matched, skip pip install."
          }

      - name: Prime depends.exe (non-interactive)
        shell: pwsh
        run: |
          $py = ".venv_lite\Scripts\python.exe"
          $env:PRE_TARGET="misc"
          & $py -m nuitka --standalone --jobs=1 --output-dir=temp_build --assume-yes-for-downloads pre_build.py

      - name: Run Nuitka Build (lite)
        shell: pwsh
        env:
          GITHUB_ACTIONS: true
          BUILD_PROFILE: lite
        run: |
          .\.venv_lite\Scripts\python.exe nuitka_build.py

      - name: Save pip cache (final-lite)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save venv (lite) (final-lite)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .venv_lite
          key: venv-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save build caches (lite) (final-lite)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Zip & Upload (lite)
        shell: pwsh
        run: Compress-Archive -Path "build/DSM_Tool.dist/*" -DestinationPath "DSM_Tool_LITE.zip"

      - name: Upload Artifact (lite)
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_LITE
          path: DSM_Tool_LITE.zip
          retention-days: 5

  pre-heavy-torch:
    needs: final-lite
    if: ${{ inputs.run_heavy }}
    runs-on: windows-latest
    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12.10"

      - name: Restore pip cache
        uses: actions/cache/restore@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}
          restore-keys: |
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-
            pip-Win-py312-

      - name: Restore venv (full)
        uses: actions/cache/restore@v4
        with:
          path: .venv_full
          key: venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            venv-full-Win-py312-

      - name: Restore build caches (full/heavy)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            build-full-Win-py312-
            build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Setup venv (full) + install deps+torch (ultra cached)
        shell: pwsh
        run: |
          $venv = ".venv_full"
          if (!(Test-Path "$venv\Scripts\python.exe")) { python -m venv $venv }

          $depsId = "$( (Get-FileHash requirements-ci.txt).Hash )-$( (Get-FileHash pre_build.py).Hash )-$( (Get-FileHash nuitka_build.py).Hash )-full-torch-cu124-gdal3114"
          $stamp = "$venv\.deps_stamp"

          $needInstall = $true
          if (Test-Path $stamp) {
            $old = (Get-Content $stamp -ErrorAction SilentlyContinue)
            if ($old -eq $depsId) { $needInstall = $false }
          }

          if ($needInstall) {
            & "$venv\Scripts\python.exe" -m pip install -U pip --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -U nuitka clcache --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -r requirements-ci.txt --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124 --cache-dir "$env:PIP_CACHE_DIR"
            Set-Content -Path $stamp -Value $depsId -Encoding ascii
          } else {
            Write-Host "Deps stamp matched, skip pip install."
          }

      - name: Pre-compile torch (Nuitka, non-interactive, avoid sympy)
        shell: pwsh
        run: |
          $py = ".venv_full\Scripts\python.exe"
          $env:PRE_TARGET="torch"
          & $py -m nuitka --standalone --jobs=2 --output-dir=temp_build --assume-yes-for-downloads `
            --nofollow-import-to=sympy `
            --nofollow-import-to=torch._dynamo `
            --nofollow-import-to=torch._inductor `
            --nofollow-import-to=torch._functorch `
            --nofollow-import-to=torch.fx `
            --nofollow-import-to=torch.compiler `
            --nofollow-import-to=torch.onnx `
            --nofollow-import-to=torch.distributed `
            --nofollow-import-to=torch.testing `
            --nofollow-import-to=torch.utils.benchmark `
            pre_build.py

      - name: Save pip cache (pre-heavy-torch)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save venv (full) (pre-heavy-torch)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .venv_full
          key: venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save build caches (full/heavy) (pre-heavy-torch)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

  final-full:
    needs: pre-heavy-torch
    if: ${{ inputs.run_heavy }}
    runs-on: windows-latest
    steps:
      - name: Maximize Build Space
        shell: pwsh
        run: |
          Get-ChildItem -Path "C:\hostedtoolcache\windows\PyPy" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force
          Get-ChildItem -Path "C:\hostedtoolcache\windows\Ruby" -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12.10"

      - name: Restore pip cache
        uses: actions/cache/restore@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}
          restore-keys: |
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-
            pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-
            pip-Win-py312-

      - name: Restore venv (full)
        uses: actions/cache/restore@v4
        with:
          path: .venv_full
          key: venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            venv-full-Win-py312-

      - name: Restore build caches (full)
        uses: actions/cache/restore@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}
          restore-keys: |
            build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-
            build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-
            build-full-Win-py312-
            build-lite-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-

      - name: Ensure venv ready (full) (skip if cached)
        shell: pwsh
        run: |
          $venv = ".venv_full"
          if (!(Test-Path "$venv\Scripts\python.exe")) { python -m venv $venv }

          $depsId = "$( (Get-FileHash requirements-ci.txt).Hash )-$( (Get-FileHash pre_build.py).Hash )-$( (Get-FileHash nuitka_build.py).Hash )-full-torch-cu124-gdal3114"
          $stamp = "$venv\.deps_stamp"

          if (!(Test-Path $stamp) -or ((Get-Content $stamp) -ne $depsId)) {
            & "$venv\Scripts\python.exe" -m pip install -U pip --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -U nuitka clcache --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install -r requirements-ci.txt --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install https://github.com/cgohlke/geospatial-wheels/releases/download/v2025.10.25/GDAL-3.11.4-cp312-cp312-win_amd64.whl --cache-dir "$env:PIP_CACHE_DIR"
            & "$venv\Scripts\python.exe" -m pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu124 --cache-dir "$env:PIP_CACHE_DIR"
            Set-Content -Path $stamp -Value $depsId -Encoding ascii
          } else {
            Write-Host "Deps stamp matched, skip pip install."
          }

      - name: Prime depends.exe (non-interactive)
        shell: pwsh
        run: |
          $py = ".venv_full\Scripts\python.exe"
          $env:PRE_TARGET="misc"
          & $py -m nuitka --standalone --jobs=1 --output-dir=temp_build --assume-yes-for-downloads pre_build.py

      - name: Run Nuitka Build (full)
        shell: pwsh
        env:
          GITHUB_ACTIONS: true
          BUILD_PROFILE: full
        run: |
          .\.venv_full\Scripts\python.exe nuitka_build.py

      - name: Save pip cache (final-full)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .pip_cache
          key: pip-Win-py312-${{ hashFiles('requirements-ci.txt') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save venv (full) (final-full)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .venv_full
          key: venv-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Save build caches (full) (final-full)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            .nuitka_cache
            .clcache
            temp_build
          key: build-full-Win-py312-${{ hashFiles('requirements-ci.txt','pre_build.py','nuitka_build.py') }}-run-${{ github.run_id }}-${{ github.job }}

      - name: Zip & Upload (full)
        shell: pwsh
        run: Compress-Archive -Path "build/DSM_Tool.dist/*" -DestinationPath "DSM_Tool_FULL.zip"

      - name: Upload Artifact (full)
        uses: actions/upload-artifact@v4
        with:
          name: DSM_Tool_FULL
          path: DSM_Tool_FULL.zip
          retention-days: 5
